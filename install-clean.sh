#!/bin/bash
# install-clean.sh - InstalaciÃ³n limpia garantizada

set -e

echo "ğŸ›¡ï¸ INSTALACIÃ“N LIMPIA DEL FORO"
echo "=============================="

# Auto-detectar configuraciÃ³n
PUBLIC_IP=$(curl -s https://ipinfo.io/ip 2>/dev/null || echo "localhost")
LOCAL_IP=$(hostname -I 2>/dev/null | awk '{print $1}' || echo "localhost")
HOSTNAME=$(hostname -f 2>/dev/null || hostname)

# Determinar mejor configuraciÃ³n
if [[ $HOSTNAME == *.* && $HOSTNAME != "localhost" ]]; then
    SERVER_HOST=$HOSTNAME
    FRONTEND_URL="https://$HOSTNAME"
    echo "âœ… Detectado dominio: $HOSTNAME"
elif [[ $PUBLIC_IP != "localhost" ]]; then
    SERVER_HOST=$PUBLIC_IP
    FRONTEND_URL="http://$PUBLIC_IP:9050"
    echo "âœ… Detectada IP pÃºblica: $PUBLIC_IP"
else
    SERVER_HOST=$LOCAL_IP
    FRONTEND_URL="http://$LOCAL_IP:9050"
    echo "âœ… Usando IP local: $LOCAL_IP"
fi

# Crear .env automÃ¡tico
cat > .env << EOF
# ===== CONFIGURACIÃ“N AUTO-GENERADA =====
SERVER_IP=$SERVER_HOST
FRONTEND_PORT=9050

# ===== BASE DE DATOS =====
POSTGRES_USER=foro_user
POSTGRES_PASSWORD=SecurePass_$(date +%s)
POSTGRES_DB=forumDB

# ===== SEGURIDAD =====
JWT_SECRET=$(openssl rand -hex 32 2>/dev/null || echo "AutoGenerated_$(date +%s)")
JWT_EXPIRES_IN=7d
EMAIL_VERIFICATION_SECRET=$(openssl rand -hex 24 2>/dev/null || echo "EmailSecret_$(date +%s)")
BCRYPT_ROUNDS=12

# ===== EMAIL =====
MAILER_SERVICE=gmail
MAILER_EMAIL=admin@localhost
MAILER_SECRET_KEY=dummy_password

# ===== CONFIGURACIÃ“N AVANZADA =====
ENABLE_QUERY_LOGGING=false
NODE_ENV=production
EOF

echo "âœ… Archivo .env generado con configuraciÃ³n segura"

# Limpiar instalaciÃ³n anterior
echo "ğŸ§¹ Limpiando instalaciÃ³n anterior..."
docker-compose down -v 2>/dev/null || true

# Desplegar
echo "ğŸš€ Desplegando servicios..."
docker-compose up -d

# Verificar
echo "â³ Esperando que los servicios estÃ©n listos..."
sleep 90

if docker-compose ps | grep -q "Up.*healthy"; then
    echo ""
    echo "ğŸ‰ Â¡INSTALACIÃ“N COMPLETADA!"
    echo "========================="
    echo "ğŸŒ Accede al foro en: $FRONTEND_URL"
    echo "ğŸ‘¤ Usuarios disponibles:"
    echo "   Admin: admin@foro.local / admin123"
    echo "   Mod: mod@foro.local / admin123"
    echo "   User: user@foro.local / admin123"
    echo ""
    echo "ğŸ”§ Comandos Ãºtiles:"
    echo "   docker-compose ps          # Ver estado"
    echo "   docker-compose logs -f     # Ver logs en tiempo real"
    echo "   docker-compose logs backend # Ver logs del backend"
    echo ""
    echo "âœ… PgBouncer configurado con fallback automÃ¡tico"
    echo "âœ… Auto-detecciÃ³n de URLs activada"
else
    echo ""
    echo "âš ï¸ Algunos servicios pueden tardar mÃ¡s. Ver estado:"
    docker-compose ps
    echo ""
    echo "Ver logs: docker-compose logs -f"
fi